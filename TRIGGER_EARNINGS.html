<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® URGENT: Trigger Daily Earnings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-red-50 to-orange-50 min-h-screen p-4">
    <div class="max-w-3xl mx-auto mt-8">
        <!-- URGENT BANNER -->
        <div class="bg-red-600 text-white p-6 rounded-t-lg text-center">
            <h1 class="text-4xl font-bold mb-2 pulse">üö® URGENT ACTION REQUIRED üö®</h1>
            <p class="text-xl">Trigger Daily Earnings - 2 Users Waiting</p>
            <p class="text-sm mt-2 opacity-90">Ryan ($62 owed) + Yana ($26 owed) = $88 total</p>
        </div>

        <div class="bg-white shadow-2xl rounded-b-lg p-8">
            <!-- STEP 1: Admin Login -->
            <div class="mb-8 border-l-4 border-blue-500 pl-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-3">üìù Step 1: Admin Login</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Admin Email:</label>
                        <input type="email" id="adminEmail" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg" 
                               placeholder="your.email@example.com"
                               value="">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Admin Password:</label>
                        <input type="password" id="adminPassword" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 text-lg" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                </div>
            </div>

            <!-- STEP 2: Trigger Button -->
            <div class="mb-8">
                <button onclick="triggerEarnings()" 
                        class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-5 px-8 rounded-lg text-xl shadow-lg transform transition hover:scale-105 active:scale-95">
                    üöÄ TRIGGER DAILY EARNINGS NOW
                </button>
                <p class="text-center text-gray-600 mt-3 text-sm">This will credit earnings to all active machines</p>
            </div>

            <!-- RESULT AREA -->
            <div id="result" class="mb-6"></div>

            <!-- WHAT WILL HAPPEN -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-blue-900 mb-3">üí° What This Will Do:</h3>
                <ul class="space-y-2 text-blue-800">
                    <li class="flex items-start">
                        <span class="mr-2">‚úÖ</span>
                        <span><strong>Ryan (ID 3):</strong> Credit $62 for 4 active machines</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2">‚úÖ</span>
                        <span><strong>Yana (ID 10):</strong> Credit $26 for 2 active machines</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2">‚úÖ</span>
                        <span><strong>Total:</strong> $88 distributed to 6 machines</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2">‚úÖ</span>
                        <span>Updates balances instantly on dashboard</span>
                    </li>
                </ul>
            </div>

            <!-- EXPECTED RESULTS -->
            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
                <h3 class="text-lg font-bold text-green-900 mb-3">üìä Expected Results:</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-white p-4 rounded border border-green-300">
                        <p class="font-bold text-gray-700 mb-2">Ryan (ryan786w@gmail.com)</p>
                        <p class="text-gray-600">Before: $4,289.23</p>
                        <p class="text-green-700 font-bold">After: $4,351.23 (+$62)</p>
                    </div>
                    <div class="bg-white p-4 rounded border border-green-300">
                        <p class="font-bold text-gray-700 mb-2">Yana (bnai48826@gmail.com)</p>
                        <p class="text-gray-600">Before: $182.80</p>
                        <p class="text-green-700 font-bold">After: $208.80 (+$26)</p>
                    </div>
                </div>
            </div>

            <!-- REMINDER -->
            <div class="mt-6 bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4">
                <p class="text-yellow-800 font-medium text-center">
                    ‚ö†Ô∏è <strong>REMINDER:</strong> Tomorrow you must implement the automated cron job!<br>
                    <span class="text-sm">See: CRON_IMPLEMENTATION_REMINDER.md</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        async function triggerEarnings() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const resultDiv = document.getElementById('result');

            // Validation
            if (!email || !password) {
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <p class="text-red-700 font-medium">‚ùå Please enter both admin email and password</p>
                    </div>
                `;
                return;
            }

            // Show loading
            resultDiv.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                    <p class="text-blue-700 font-medium">‚è≥ Step 1/2: Logging in as admin...</p>
                </div>
            `;

            try {
                // Step 1: Login as admin
                console.log('üîê Attempting admin login...');
                const loginResponse = await fetch('https://www.deepmineai.vip/api/auth/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                if (!loginResponse.ok) {
                    const errorData = await loginResponse.json().catch(() => ({ message: 'Login failed' }));
                    throw new Error(errorData.message || 'Invalid admin credentials - please check email and password');
                }

                const loginData = await loginResponse.json();
                
                if (!loginData.token) {
                    throw new Error('Login succeeded but no token received');
                }

                const token = loginData.token;
                console.log('‚úÖ Login successful, token received');

                // Update loading message
                resultDiv.innerHTML = `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <p class="text-blue-700 font-medium">‚úÖ Step 1/2: Login successful!</p>
                        <p class="text-blue-700 font-medium mt-2">‚è≥ Step 2/2: Calculating and distributing earnings...</p>
                    </div>
                `;

                // Step 2: Trigger earnings calculation
                console.log('üí∞ Triggering earnings calculation...');
                const earningsResponse = await fetch('https://www.deepmineai.vip/api/earnings/calculate-daily', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!earningsResponse.ok) {
                    const errorData = await earningsResponse.json().catch(() => ({ message: 'Earnings calculation failed' }));
                    throw new Error(errorData.message || `Earnings API returned ${earningsResponse.status}`);
                }

                const earningsData = await earningsResponse.json();
                console.log('üìä Earnings result:', earningsData);

                if (earningsData.success) {
                    // SUCCESS!
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg shadow-lg">
                            <h3 class="text-green-900 font-bold text-2xl mb-4 flex items-center">
                                <span class="text-4xl mr-3">‚úÖ</span>
                                SUCCESS! Earnings Distributed
                            </h3>
                            <div class="space-y-3 text-green-800">
                                <div class="bg-white p-4 rounded border-2 border-green-300">
                                    <p class="text-lg"><strong>üìÖ Date:</strong> ${earningsData.date}</p>
                                </div>
                                <div class="bg-white p-4 rounded border-2 border-green-300">
                                    <p class="text-lg"><strong>ü§ñ Machines Processed:</strong> ${earningsData.processed_machines} / ${earningsData.total_machines || earningsData.processed_machines}</p>
                                </div>
                                <div class="bg-white p-4 rounded border-2 border-green-300">
                                    <p class="text-lg"><strong>üíµ Total Distributed:</strong> $${earningsData.total_distributed.toFixed(2)}</p>
                                </div>
                                ${earningsData.errors && earningsData.errors.length > 0 ? `
                                    <div class="bg-red-50 p-4 rounded border-2 border-red-300">
                                        <p class="text-red-700"><strong>‚ö†Ô∏è Errors:</strong> ${earningsData.errors.length} machines failed</p>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="mt-6 pt-4 border-t-2 border-green-300">
                                <p class="text-green-900 font-bold text-center text-lg">
                                    üéâ Users can now see updated balances on their dashboards!
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(earningsData.message || 'Earnings calculation returned success: false');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg shadow-lg">
                        <h3 class="text-red-900 font-bold text-xl mb-3 flex items-center">
                            <span class="text-3xl mr-2">‚ùå</span>
                            Error Occurred
                        </h3>
                        <p class="text-red-700 mb-4"><strong>Error:</strong> ${error.message}</p>
                        <div class="bg-white p-4 rounded border border-red-300">
                            <p class="text-red-800 font-medium mb-2">Common Issues:</p>
                            <ul class="text-red-700 text-sm space-y-1 list-disc list-inside">
                                <li>Check admin email and password are correct</li>
                                <li>Ensure you have admin privileges</li>
                                <li>Check browser console (F12) for detailed error</li>
                                <li>Verify platform is accessible at https://www.deepmineai.vip</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    triggerEarnings();
                }
            });
        });
    </script>
</body>
</html>
